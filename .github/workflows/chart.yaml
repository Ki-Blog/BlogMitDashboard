name: Deploy Helm Chart to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Allow write permissions for contents

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Helm
      uses: azure/setup-helm@v1

    - name: Package Helm chart
      run: helm package k8s/BlogDashboard-chart

    - name: Set up Git
      run: |
        git config --global user.email "sadekmurad@outlook.de"
        git config --global user.name "Sadek Murad"

    - name: Create gh-pages branch if not exists
      run: |
        git clone https://x-access-token:${{ secrets.GITHUBTAG }}@github.com/Sadek-Murad/HelmChartRepo.git repo
        cd repo
        if git show-ref --quiet refs/heads/gh-pages; then
          echo "gh-pages branch already exists"
        else
          git checkout --orphan gh-pages
          git reset --hard
          git commit --allow-empty -m "Initial commit on gh-pages branch"
          git push https://x-access-token:${{ secrets.GITHUBTAG }}@github.com/Sadek-Murad/HelmChartRepo.git gh-pages
        fi
        cd ..

    - name: Checkout gh-pages branch
      uses: actions/checkout@v2
      with:
        repository: Sadek-Murad/HelmChartRepo
        ref: gh-pages
        token: ${{ secrets.GITHUBTAG }}
        fetch-depth: 0

    - name: Copy new chart package
      run: cp ../*.tgz .

    - name: Generate Helm repo index
      run: helm repo index . --url https://Sadek-Murad.github.io/HelmChartRepo/

    - name: Add and commit changes
      run: |
        git add .
        git commit -m "feat: Publish new Helm chart"

    - name: Push changes to gh-pages
      run: git push https://x-access-token:${{ secrets.GITHUBTAG }}@github.com/Sadek-Murad/HelmChartRepo.git gh-pages --force
