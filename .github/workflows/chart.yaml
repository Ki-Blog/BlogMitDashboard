name: Deploy Helm Chart to GitHub Pages

on:
  push:
    branches:
      - gh-pages

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Allow write permissions for contents

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Helm
      uses: azure/setup-helm@v1

    - name: Package Helm chart
      run: helm package k8s/BlogDashboard-chart

    - name: Checkout the target repository
      uses: actions/checkout@v2
      with:
        repository: Sadek-Murad/HelmChartRepo
        ref: gh-pages
        token: ${{ secrets.GITHUBTAG }}
        fetch-depth: 0

    - name: Copy new chart package
      run: cp ../*.tgz .

    - name: Generate Helm repo index
      run: helm repo index . --url https://Sadek-Murad.github.io/HelmChartRepo/

    - name: Add and commit changes
      run: |
        git add .
        git commit -m "feat: Publish new Helm chart"

    - name: Push changes to gh-pages
      run: git push https://x-access-token:${{ secrets.GITHUBTAG }}@github.com/Sadek-Murad/HelmChartRepo.git gh-pages --force
