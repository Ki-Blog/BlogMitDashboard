name: Deploy Helm Chart to GitHub Pages

on:
  push:
    branches:
      - gh-pages

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Helm
      uses: azure/setup-helm@v1

    - name: Package Helm chart
      run: helm package k8s/BlogDashboard-chart

    - name: Create GitHub Pages branch if not exists
      run: |
        git fetch origin gh-pages
        if git show-ref --quiet refs/heads/gh-pages; then
          echo "gh-pages branch already exists"
        else
          git checkout --orphan gh-pages
          git reset --hard
          git commit --allow-empty -m "feat: Initial commit on gh-pages branch"
          git push origin gh-pages
        fi

    - name: Checkout gh-pages branch
      run: |
        git config --global user.email "sadekmurad@outlook.de"
        git config --global user.name "Sadek Murad"
        git checkout gh-pages
        git pull origin gh-pages

    - name: Move new chart package
      run: mv -n *.tgz .

    - name: Generate Helm repo index
      run: helm repo index . --url https://ki-blog.github.io/BlogMitDashboard/

    - name: Add and commit changes
      run: |
        git add .
        git commit -m "feat: Publish new Helm chart"

    - name: Push changes to gh-pages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUBTAG }}
      run: |
        git push https://x-access-token:${GITHUB_TOKEN}@git@github.com:Ki-Blog/BlogMitDashboard.git gh-pages --force